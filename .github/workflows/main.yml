name: Code Scan with Cortex

on:
  push:
    branches:
      - temp-branch
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY }}
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_URL: https://api-u-infra-260126-xdr.xdr.sg.paloaltonetworks.com

jobs:
  cortex-code-scan:
    name: Cortex code scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
# Cotrex PR Test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Set up Java (cortexcli 요구: Java 11 이상)"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: "Set up Node.js (SCA 스캔 요구: Node.js 22 이상)"
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Cortex CLI dependencies (libhs.so.5)
        run: |
          sudo apt-get update
          sudo apt-get install -y libhyperscan5

      - name: Download Cortex CLI and run code scan
        id: cortex_scan
        continue-on-error: true
        run: |
          set -x
          crtx_resp=$(curl -s "${{ env.CORTEX_API_URL }}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${{ env.CORTEX_API_KEY_ID }}" \
            -H "Authorization: ${{ env.CORTEX_API_KEY }}")
          
          crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url // empty")
          crtx_file=$(echo "$crtx_resp" | jq -r ".file_name // empty")

          if [ -z "$crtx_url" ] || [ "$crtx_url" = "null" ]; then
            echo "Error: Failed to get download URL. API response: $crtx_resp"
            exit 1
          fi

          curl -o "$crtx_file" "$crtx_url"
          chmod +x "$crtx_file"
          ./"$crtx_file" --api-base-url "${{ env.CORTEX_API_URL }}" \
            --api-key "${{ env.CORTEX_API_KEY }}" \
            --api-key-id "${{ env.CORTEX_API_KEY_ID }}" \
            code scan --directory "${{ github.workspace }}" \
            --branch ${{ github.ref_name }} --repo-id "${{ github.repository }}" \
            --source "GITHUB_ACTIONS" \
            --output json \
            --output-file-path .result.json
# (아래는 GitHub Actions Summary 탭에 결과를 직접 출력할 때 사용하는 옵션입니다)
#            --output cli \
#            --compact > scan_result.txt
#          cat scan_result.txt
#          head -c 1000000 scan_result.txt > $GITHUB_STEP_SUMMARY

      - name: Show scan result # 생성된 JSON 결과를 로그창에 출력하는 단계
        run: cat .result.json
         
